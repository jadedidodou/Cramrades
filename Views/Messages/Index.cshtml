@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Messages</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-box {
            height: 70vh;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #ddd;
        }

        .attachment {
            border-left: 4px solid #0d6efd;
            background: #e7f1ff;
            padding: 10px;
            margin-top: 5px;
        }
    </style>
</head>
<body class="p-3">

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3>💬 Study Chat</h3>
            <a href="/Home/Feed" class="btn btn-outline-secondary">Back to Feed</a>
        </div>

        <div id="messages-list" class="chat-box p-3 rounded mb-3">
        </div>

        <div class="input-group">
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#uploadModal">📎 Attach File</button>
            <input type="text" id="msgInput" class="form-control" placeholder="Type a message...">
            <button onclick="sendText()" class="btn btn-primary">Send</button>
        </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Study Material</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="file" id="fileInput" class="form-control mb-3">

                    <label class="fw-bold">Which subject is this for?</label>
                    <select id="fileSubject" class="form-select">
                        <option value="Math">Mathematics</option>
                        <option value="Programming">Programming</option>
                        <option value="History">History</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button onclick="sendFile()" class="btn btn-primary">Send Attachment</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp }
        from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // 🔴 PASTE YOUR FIREBASE CONFIG HERE
        const firebaseConfig = {
            apiKey: "AIzaSyDrkRtgGhFWSvEiDr5pZy2sGDHI8HCpPt0",
            authDomain: "cramrades.firebaseapp.com",
            projectId: "cramrades",
            storageBucket: "cramrades.firebasestorage.app",
            messagingSenderId: "421414498264",
            appId: "1:421414498264:web:58e04c186d5bdea7c88cad"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const chatRef = collection(db, "chats");

        // 1. Listen for Messages
        const q = query(chatRef, orderBy("createdAt"));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById("messages-list");
            list.innerHTML = "";
            snapshot.forEach(doc => {
                const data = doc.data();

                // CHECK: Is it Text or File?
                let content = "";
                if (data.type === "text") {
                    content = `<div>${data.text}</div>`;
                } else {
                    // Render the Attachment Card with Label
                    content = `
                        <div class="attachment rounded">
                            <strong>📎 ${data.fileName}</strong><br>
                            <span class="badge bg-secondary">${data.subjectLabel}</span>
                        </div>
                    `;
                }

                list.innerHTML += `<div class="mb-2 bg-white p-2 shadow-sm rounded">${content}</div>`;
            });
            list.scrollTop = list.scrollHeight;
        });

        // 2. Send Text
        window.sendText = async () => {
            const txt = document.getElementById("msgInput").value;
            if(!txt) return;
            await addDoc(chatRef, { type: "text", text: txt, createdAt: serverTimestamp() });
            document.getElementById("msgInput").value = "";
        }

        // 3. Send File (Simulated)
        window.sendFile = async () => {
            const file = document.getElementById("fileInput").files[0];
            const subject = document.getElementById("fileSubject").value;
            if(!file) return;

            await addDoc(chatRef, {
                type: "file",
                fileName: file.name,
                subjectLabel: subject, // <--- SAVING THE LABEL
                createdAt: serverTimestamp()
            });

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
            modal.hide();
        }
    </script>
</body>
</html>