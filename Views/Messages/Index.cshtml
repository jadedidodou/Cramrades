@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/u/0/d/1D0x68ABVp7J6UMG0svEjWsI8m9dLdlr4">
    <title>Cramrades</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Carter+One&family=Fredoka:wght@300..700&family=Lexend:wght@100..900&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #ffffff;
            height: 100vh;
            overflow: hidden;
            font-family: 'Lexend', sans-serif;
            color: #170007;
            margin: 0;
            background-image: url('/images/background.png');
            background-size: cover;
            background-position: center;
        }

        .app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            width: 360px;
            background: #fffcf8;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 20;
        }

        .sidebar-header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
            font-size: 24px;
        }

        .sidebar-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.2s;
            text-decoration: none;
            margin-bottom: 5px;
        }

            .chat-item:hover {
                background-color: #f0f2f5;
            }

            .chat-item.active {
                background-color: #FFEBF1;
            }

        .chat-item-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            background-color: #eee;
        }

        .main-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-header {
            background: #fffcf8;
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.6); /* White tint over bg */
        }

        #message-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 100%;
            max-width: 850px;
            margin: 0 auto;
        }

        .message-row {
            display: flex;
            flex-direction: column;
            max-width: 75%;
            margin-bottom: 2px;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 15px;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .me {
            align-self: flex-end;
            align-items: flex-end;
        }

            .me .message-bubble {
                background: #48B584;
                color: white;
                border-bottom-right-radius: 4px;
            }

        .them {
            align-self: flex-start;
            align-items: flex-start;
        }

            .them .message-bubble {
                background: #fffcf8;
                color: #333;
                border-bottom-left-radius: 4px;
            }

        .meta {
            font-size: 10px;
            color: #6c757d;
            margin: 2px 5px;
            opacity: 0;
            transition: 0.2s;
        }

        .message-row:hover .meta {
            opacity: 1;
        }

        .date-separator {
            text-align: center;
            margin: 20px 0 10px 0;
            font-size: 11px;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(255,255,255,0.6);
            display: inline-block;
            align-self: center;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .chat-footer {
            background-color: #fffcf8;
            padding: 15px;
            display: flex;
            justify-content: center;
        }

        .chat-footer .btn-primary {
				background-color: #48B584;
				border-color: #48B584;
        }

        .footer-content {
            width: 100%;
            max-width: 850px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input {
            background: #f0f2f5;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            flex: 1;
            outline: none;
        }

        .btn-menu {
            border: none;
            background: transparent;
            padding: 5px 10px;
            border-radius: 50%;
            color: #6c757d;
        }

            .btn-menu:hover {
                background-color: #f0f2f5;
                color: #000;
            }

        #match-badge {
            color: #48B584;
        }

        .badge-high-match {
            background-color: #48B584 !important; 
            color: white !important;
            border: 1px solid #48B584;
        }
        .badge-mid-match {
            background-color: #ffc107 !important; 
            color: #000 !important;
            border: 1px solid #ffc107;
        }
        .badge-low-match {
            background-color: #f8d7da !important;
            color: #721c24 !important;
            border: 1px solid #f5c6cb;
        }

        .blocked-footer {
            opacity: 0.5;
            pointer-events: none; 
            background-color: #e9ecef !important;
        }

        @@media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="sidebar d-none d-md-flex">
            <div class="sidebar-header">
                <span>Chats</span>
                <a href="/Home/Index" class="btn btn-sm "><i class="bi bi-house-door-fill" style="color: #ffa4c0; font-size: 30px"></i></a>
            </div>
            <div class="p-2">
                <input type="text" id="searchInput" class="form-control rounded-pill bg-light border-0" placeholder="Search chats..." onkeyup="filterChats()">
            </div>
            <div class="sidebar-scroll" id="sidebar-list">
                <div class="text-center mt-5 text-muted">
                    <div class="spinner-border spinner-border-sm"></div>
                    <p class="small mt-2">Loading...</p>
                </div>
            </div>
        </div>

        <div class="main-chat-area">
            <div class="chat-header">
                <div class="d-flex align-items-center w-100" style="max-width: 850px; margin: 0 auto;">
                    <a href="/Home/Index" class="btn btn-light btn-sm me-3 border-0 rounded-circle shadow-sm d-md-none">
                        <i class="bi bi-arrow-left fs-5"></i>
                    </a>

                    <div class="d-flex align-items-center flex-grow-1 p-1 rounded ps-2 position-relative"
                         onclick="openPartnerProfile()"
                         style="cursor: pointer; z-index: 1050;">

                        <img id="header-img" src="" class="header-avatar me-3"
                             onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=Student&background=random'">

                        <div>
                            <div class="d-flex align-items-center gap-2">
                                <h5 class="mb-0 fw-bold text-dark" id="chat-name">Loading...</h5>
                            </div>
                            <small class="text-muted" style="font-size: 0.75rem;">Tap to view details</small>
                        </div>
                    </div>

                    <div class="dropdown ms-auto">
                        <button class="btn-menu" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical fs-5"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-4">
                            <li>
                                <button class="dropdown-item text-danger" onclick="confirmDeleteChat()">
                                    <i class="bi bi-trash me-2"></i> Delete Conversation
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item" onclick="openReportModal()">
                                    <i class="bi bi-flag me-2"></i> Report User
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <button class="dropdown-item text-dark fw-bold" onclick="confirmBlockUser()" id="btn-block-toggle">
                                    <i class="bi bi-slash-circle me-2"></i> Block User
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="chat-container" id="scroll-container">
                <div id="icebreakers" class="text-center mt-5" style="display:none; max-width:850px; margin:50px auto;">
                    <div class="mb-4" style="font-size: 40px;">👋</div>
                    <h5 class="text-muted fw-bold">Break the ice!</h5>
                    <div class="mt-3">
                        <button class="btn btn-outline-primary rounded-pill m-1" onclick="sendStarter('Hi! I saw we have similar study vibes! 🎓')">👋 Hi! We matched!</button>
                        <button class="btn btn-outline-primary rounded-pill m-1" onclick="sendStarter('Are you free to study? 📚')">📚 Free to study?</button>
                    </div>
                </div>
                <div id="message-list"></div>
            </div>

            <div class="chat-footer">
                <div class="footer-content">
                    <button class="btn btn-light rounded-circle text-secondary" data-bs-toggle="modal" data-bs-target="#uploadModal"><i class="bi bi-paperclip fs-5"></i></button>
                    <input type="text" id="messageInput" class="chat-input" placeholder="Type a message..." onkeypress="handleEnter(event)">
                    <button onclick="sendMessage()" class="btn btn-primary rounded-circle shadow-sm"><i class="bi bi-send-fill"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade rounded-4" id="partnerProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-header bg-light border-0 d-flex flex-column align-items-center pt-5 pb-4" style="background-image: url('/images/profile bg.png'); background-size: cover">
                    <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                    <img id="raw-img" src="" class="rounded-circle shadow-sm mb-3" style="width: 100px; height: 100px; object-fit: cover;">
                    <h4 id="raw-name" class="fw-bold mb-0">User</h4>
                    <span id="match-badge" class="badge bg-white border border-danger-subtle rounded-pill mt-2 text-danger">0% Match</span>
                </div>
                <div class="modal-body px-4 pb-4" style="height:400px; overflow-y: auto; background-color:#fffcf8">
                    <label class="small fw-bold text-muted">About</label><p id="raw-bio" class="small mb-2">...</p>
                    <label class="small fw-bold text-muted">Vibe</label><p id="raw-vibe" class="small mb-2">...</p>
                    <label class="small fw-bold text-muted">Program</label><p id="raw-program" class="small mb-2">...</p>
                    <label class="small fw-bold text-muted">Skills</label><div id="raw-skills" class="d-flex flex-wrap mb-2"></div>
                    <label class="small fw-bold text-muted">Availability</label><div id="raw-schedule" class="mt-1 border rounded bg-white"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-body p-4">
                    <h5 class="fw-bold mb-3">📤 Share File</h5>
                    <input type="file" class="form-control mb-3" id="fileInput">
                    <select class="form-select mb-3" id="subjectSelect">
                        <optgroup label="General">
                            <option>Mathematics</option>
                            <option>Science</option>
                            <option>English / Literature</option>
                            <option>History / Rizal</option>
                            <option>Filipino</option>
                        </optgroup>
                        <optgroup label="Technology">
                            <option>Programming</option>
                            <option>Web Development</option>
                            <option>Data Structures</option>
                            <option>Database</option>
                            <option>Networking</option>
                        </optgroup>
                        <optgroup label="Business">
                            <option>Accounting</option>
                            <option>Economics</option>
                            <option>Marketing</option>
                        </optgroup>
                    </select>
                    <button onclick="handleFileUpload()" class="btn w-100 rounded-pill" style="background-color: #5bcbff">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-body p-4 text-center">
                    <div class="bg-danger-subtle text-danger rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-trash3-fill fs-3"></i>
                    </div>
                    <h5 class="fw-bold mb-2">Delete Chat?</h5>
                    <p class="text-muted small mb-4">This will permanently remove this conversation for you. This cannot be undone.</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-danger rounded-pill fw-bold" onclick="executeDelete()">Yes, Delete it</button>
                        <button type="button" class="btn btn-light rounded-pill fw-bold" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="blockConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow rounded-4">
                <div class="modal-body p-4 text-center">
                    <div class="bg-dark-subtle text-dark rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                        <i class="bi bi-slash-circle fs-3"></i>
                    </div>
                    <h5 class="fw-bold mb-2" id="blockModalTitle">Block User?</h5>
                    <p class="text-muted small mb-4" id="blockModalText">You won't receive messages from them anymore.</p>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-dark rounded-pill fw-bold" onclick="executeBlockToggle()" id="blockModalBtn">Yes, Block</button>
                        <button type="button" class="btn btn-light rounded-pill fw-bold" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0">
                <div class="modal-body p-4">
                    <h5 class="fw-bold text-danger mb-3">Report User</h5>
                    <textarea class="form-control mb-3" id="reportReason" placeholder="Reason..."></textarea>
                    <button onclick="submitReport()" class="btn btn-danger w-100 rounded-pill">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, where, doc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrkRtgGhFWSvEiDr5pZy2sGDHI8HCpPt0",
            authDomain: "cramrades.firebaseapp.com",
            projectId: "cramrades",
            storageBucket: "cramrades.firebasestorage.app",
            messagingSenderId: "421414498264",
            appId: "1:421414498264:web:58e04c186d5bdea7c88cad"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const params = new URLSearchParams(window.location.search);
        const chatId = params.get("chatId");
        const myUid = localStorage.getItem("tempUid");

        let partnerName = params.get("name") || "Student";
        let activePartnerId = params.get("partnerId");

        // --- GLOBAL STATE FOR BLOCKING ---
        let isBlocked = false; // Tracks if current partner is blocked

        if(!chatId || !myUid) window.location.href = "/Home/Index";

        // UI Helpers
        const setText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };
        const setSrc = (id, src) => { const el = document.getElementById(id); if (el) el.src = src; };

        // Initial Setup
        setText("chat-name", partnerName);
        setSrc("header-img", `https://ui-avatars.com/api/?name=${partnerName}&background=random`);

        // --- 1. UPDATED HEADER LOADER (Now checks Block Status) ---
        async function loadHeaderInfo() {
            try {
                // ... (Keep your existing ID finding logic here) ...
                if (!activePartnerId) { /* ... logic to find ID ... */ }

                if (activePartnerId) {
                    const userDoc = await getDoc(doc(db, "users", activePartnerId));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        // ... (Update Name/Photo logic) ...
                        if(data.name) {
                            partnerName = data.name;
                            setText("chat-name", data.name);
                        }
                    }

                    // --- NEW: CHECK IF BLOCKED ---
                    checkBlockStatus();
                }
            } catch(e) { console.error("Header Error:", e); }
        }

        // --- 2. CHECK BLOCK STATUS ---
        async function checkBlockStatus() {
            try {
                const myDoc = await getDoc(doc(db, "users", myUid));
                if (myDoc.exists()) {
                    const myData = myDoc.data();
                    const blockedList = myData.blockedUsers || [];

                    isBlocked = blockedList.includes(activePartnerId);

                    // A. Update Dropdown Text
                    const btn = document.getElementById("btn-block-toggle");
                    if(btn) {
                        btn.innerHTML = isBlocked
                            ? `<i class="bi bi-check-circle me-2"></i> Unblock User`
                            : `<i class="bi bi-slash-circle me-2"></i> Block User`;
                        btn.className = isBlocked ? "dropdown-item text-success fw-bold" : "dropdown-item text-dark fw-bold";
                    }

                    // B. UPDATE CHAT INPUTS 
                    const footer = document.querySelector(".chat-footer");
                    const input = document.getElementById("messageInput");

                    if (isBlocked) {
                        // Disable everything
                        if(footer) footer.classList.add("blocked-footer");
                        if(input) {
                            input.disabled = true;
                            input.value = ""; // Clear text
                            input.placeholder = "You have blocked this user.";
                        }
                    } else {
                        // Enable everything
                        if(footer) footer.classList.remove("blocked-footer");
                        if(input) {
                            input.disabled = false;
                            input.placeholder = "Type a message...";
                        }
                    }
                }
            } catch(e) { console.error("Block check error", e); }
        }

        // --- 3. DELETE FUNCTIONALITY ---
        window.confirmDeleteChat = () => {
            new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
        }

        window.executeDelete = async () => {
            try {
                await deleteDoc(doc(db, "chats", chatId));
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                // Redirect
                window.location.href = "/Home/Index";
            } catch (error) {
                alert("Error deleting chat.");
                console.error(error);
            }
        }

        // --- 4. BLOCK FUNCTIONALITY (With Toggle) ---
        window.confirmBlockUser = () => {
            // Update Modal Text based on current state
            const title = document.getElementById("blockModalTitle");
            const text = document.getElementById("blockModalText");
            const btn = document.getElementById("blockModalBtn");

            if (isBlocked) {
                title.innerText = "Unblock User?";
                text.innerText = "They will be able to message you again.";
                btn.innerText = "Yes, Unblock";
                btn.className = "btn btn-success rounded-pill fw-bold";
            } else {
                title.innerText = "Block User?";
                text.innerText = "You won't receive messages from them anymore.";
                btn.innerText = "Yes, Block";
                btn.className = "btn btn-dark rounded-pill fw-bold";
            }

            new bootstrap.Modal(document.getElementById('blockConfirmModal')).show();
        }

        window.executeBlockToggle = async () => {
            if (!activePartnerId) return;
            const myRef = doc(db, "users", myUid);
            const modal = bootstrap.Modal.getInstance(document.getElementById('blockConfirmModal'));

            try {
                if (isBlocked) {
                    // UNBLOCK
                    await updateDoc(myRef, { blockedUsers: arrayRemove(activePartnerId) });
                    alert(`User unblocked.`);
                } else {
                    // BLOCK
                    await updateDoc(myRef, { blockedUsers: arrayUnion(activePartnerId) });
                    alert(`User blocked.`);
                }

                modal.hide();
                checkBlockStatus(); // Refresh UI

                // Optional: Redirect home if you blocked them
                if(!isBlocked) window.location.href = "/Home/Index";

            } catch (error) {
                console.error("Block error:", error);
                alert("Action failed.");
            }
        }

        // --- 5. REPORT FUNCTIONALITY (Auto-Block) ---
        window.submitReport = async () => {
            const reason = document.getElementById("reportReason").value.trim();
            if (!reason) return alert("Please enter a reason.");

            try {
                // A. Save Report
                await addDoc(collection(db, "reports"), {
                    reporterId: myUid,
                    reportedChatId: chatId,
                    reportedUserId: activePartnerId, // Important
                    reportedName: partnerName,
                    reason: reason,
                    timestamp: new Date().toISOString()
                });

                // B. Auto-Block Logic
                const myRef = doc(db, "users", myUid);
                await updateDoc(myRef, { blockedUsers: arrayUnion(activePartnerId) });

                // C. Clean up
                const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                modal.hide();
                document.getElementById("reportReason").value = "";

                alert("Report submitted. This user has been automatically blocked.");
                window.location.href = "/Home/Index";

            } catch (error) {
                console.error("Error reporting:", error);
                alert("Failed to send report.");
            }
        }
        loadHeaderInfo();

        // --- 2. SIDEBAR LIST ---
        async function loadSidebarChats() {
            const sidebarList = document.getElementById("sidebar-list");
            const q = query(collection(db, "chats"), where("participants", "array-contains", myUid));

            onSnapshot(q, (snapshot) => {
                const chatsData = [];
                snapshot.forEach(doc => { const d = doc.data(); d.id = doc.id; chatsData.push(d); });
                chatsData.sort((a, b) => new Date(b.lastMessageTime || 0) - new Date(a.lastMessageTime || 0));

                let html = "";
                chatsData.forEach(chat => {
                    if(!chat.participants || chat.participants.length < 2) return;
                    const otherId = chat.participants.find(id => id !== myUid);
                    let displayName = (chat.participantNames && chat.participantNames[otherId]) || "User";
                    let displayImg = `https://ui-avatars.com/api/?name=${displayName}&background=random`;
                    const isActive = chat.id === chatId ? "active" : "";

                    html += `
                        <a href="/Home/Messages?chatId=${chat.id}&name=${encodeURIComponent(displayName)}&partnerId=${otherId}" class="chat-item ${isActive}">
                            <img src="${displayImg}" class="chat-item-avatar shadow-sm needs-photo" data-userid="${otherId}">
                            <div style="overflow:hidden;">
                                <div class="fw-bold text-dark text-truncate">${displayName}</div>
                                <div class="small text-muted text-truncate">${chat.lastMessage || "No messages yet"}</div>
                            </div>
                        </a>`;
                });

                if(sidebarList) sidebarList.innerHTML = html || `<div class="text-center mt-5 text-muted"><small>No chats found.</small></div>`;

                // Lazy Load Photos
                document.querySelectorAll('.needs-photo').forEach(async (img) => {
                    const uid = img.dataset.userid;
                    try {
                        const snap = await getDoc(doc(db, "users", uid));
                        if(snap.exists() && snap.data().photoURL) img.src = snap.data().photoURL;
                    } catch(e) {}
                });
            });
        }
        loadSidebarChats();

        // --- 3. OPEN PROFILE (THE LOGIC FIX IS HERE) ---
        window.openPartnerProfile = async () => {
            console.log("Opening profile...");

            // CRITICAL FIX: Ensure we are not comparing Self vs Self
            if (!activePartnerId || activePartnerId === myUid) {
                console.log("Fixing ID mismatch...");
                try {
                    const chatDoc = await getDoc(doc(db, "chats", chatId));
                    if(chatDoc.exists()) {
                        // FORCE finding the OTHER person
                        const parts = chatDoc.data().participants;
                        activePartnerId = parts.find(p => p !== myUid);
                        console.log("Found correct partner ID:", activePartnerId);
                    }
                } catch(e) { console.error(e); }
            }

            if (!activePartnerId) return alert("Loading data... please click again.");

            try {
                const [partnerSnap, mySnap] = await Promise.all([
                    getDoc(doc(db, "users", activePartnerId)),
                    getDoc(doc(db, "users", myUid))
                ]);

                if (partnerSnap.exists()) {
                    const data = partnerSnap.data(); // Them
                    const myData = mySnap.exists() ? mySnap.data() : {}; // You

                    // --- CALCULATION LOGIC ---
                    console.log("Calculating match between:", myData.name, "and", data.name);

                    let score = 0;

                    // 1. VIBE (+40%)
                    if (myData.studyVibe && data.studyVibe && myData.studyVibe === data.studyVibe) {
                        score += 40;
                    }

                    // 2. PROGRAM (+30%)
                    if (myData.program && data.program && myData.program === data.program) {
                        score += 30;
                    }

                    // 3. REGION (+10%)
                    if (myData.region && data.region && myData.region === data.region) {
                        score += 10;
                    }

                    // 4. SKILLS (+20%)
                    const mySkills = myData.skills || [];
                    const theirSkills = data.skills || [];
                    if (mySkills.length > 0 && theirSkills.length > 0) {
                        const mySubs = mySkills.map(s => s.subject);
                        const theirSubs = theirSkills.map(s => s.subject);
                        if (mySubs.some(s => theirSubs.includes(s))) score += 20;
                    }

                    // Fallback
                    if (score === 0) score = 10;

                    // --- UPDATE UI ---
                    setText("match-badge", `${score}% Match`);

                    // 1. BADGE COLOR LOGIC
                    const badge = document.getElementById("match-badge");
                    if(badge) {
                        // We remove old classes and add our new Custom CSS classes
                        badge.className = "badge rounded-pill mt-2 px-3 shadow-sm " +
                                          (score >= 80 ? "badge-high-match" :
                                           score >= 50 ? "badge-mid-match" : "badge-low-match");
                    }

                    setText("raw-name", data.name || "Student");
                    setText("raw-program", data.program || "N/A");
                    setText("raw-year", data.yearLevel || "");
                    setText("raw-vibe", (data.studyVibe || "General") + " Vibe");
                    setText("raw-bio", data.bio || "No bio.");

                    // 2. PROFILE PICTURE (DP) FALLBACK
                    // If they have a photo, use it. IF NOT, generate one using their name.
                    if(data.photoURL) {
                        setSrc("raw-img", data.photoURL);
                    } else {
                        setSrc("raw-img", `https://ui-avatars.com/api/?name=${data.name || 'User'}&background=random`);
                    }

                    // Skills
                    const skillsBox = document.getElementById("raw-skills");
                    if(skillsBox) {
                        skillsBox.innerHTML = "";
                        if (data.skills && data.skills.length > 0) {
                            data.skills.forEach(s => skillsBox.innerHTML += `<span class="badge bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle fw-normal me-1">${s.subject}</span>`);
                        } else { skillsBox.innerHTML = "<small class='text-muted'>No subjects.</small>"; }
                    }

                    // Schedule
                    const schedBox = document.getElementById("raw-schedule");
                    if(schedBox) {
                        schedBox.innerHTML = "";
                        const sched = data.availabilityDetails || [];
                        sched.forEach(slot => {
                            let start = formatTo12Hour(slot.startTime);
                            let end = formatTo12Hour(slot.endTime);
                            let time = ((!start && !end) || (slot.startTime === "00:00")) ? "Anytime" : `${start} - ${end}`;
                            schedBox.innerHTML += `<div class="d-flex justify-content-between px-3 py-2 border-bottom last-border-0 bg-light-subtle"><span class="fw-bold small text-dark">${slot.day}</span><span class="small text-muted">${time}</span></div>`;
                        });
                        if(sched.length === 0) schedBox.innerHTML = "<div class='p-3 small text-muted text-center'>Flexible.</div>";
                    }

                    new bootstrap.Modal(document.getElementById('partnerProfileModal')).show();
                }
            } catch (error) { console.error("Profile Error:", error); }
        }

        // --- 4. MESSAGES ---
        const messagesRef = collection(db, "chats", chatId, "messages");
        const qMsg = query(messagesRef);

        onSnapshot(qMsg, (snapshot) => {
            const messageList = document.getElementById("message-list");
            const icebreakers = document.getElementById("icebreakers");
            const scrollContainer = document.getElementById("scroll-container");

            let allMessages = [];
            snapshot.forEach((doc) => allMessages.push(doc.data()));
            allMessages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

            if(messageList) messageList.innerHTML = "";

            if (allMessages.length === 0) {
                if(icebreakers) icebreakers.style.display = "block";
            } else {
                if(icebreakers) icebreakers.style.display = "none";
                let lastTime = null;
                allMessages.forEach((msg) => {
                    const msgDate = new Date(msg.createdAt);
                    if (!lastTime || (msgDate - lastTime) > (20 * 60 * 1000)) {
                        const separator = document.createElement("div");
                        separator.className = "date-separator";
                        separator.innerText = formatDateHeader(msgDate);
                        messageList.appendChild(separator);
                    }
                    lastTime = msgDate;
                    renderMessage(msg, msg.senderId === myUid ? "me" : "them");
                });
                if(scrollContainer) scrollContainer.scrollTop = scrollContainer.scrollHeight;
            }
        });

        // --- UTILS ---
        function formatTo12Hour(timeStr) {
            if (!timeStr) return null;
            let [h, m] = timeStr.split(':');
            if (!m) m = "00"; h = parseInt(h, 10);
            if (isNaN(h)) return null;
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${m} ${ampm}`;
        }

        function formatDateHeader(date) {
            return date.toLocaleDateString([], { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });
        }

        function renderMessage(msg, type) {
            const messageList = document.getElementById("message-list");
            if(!messageList) return;
            const div = document.createElement("div");
            div.className = `message-row ${type}`;
            let content = msg.type === "file" ?
                `<div class="message-bubble shadow-sm bg-light text-dark border"><a href="${msg.fileData}" download="${msg.fileName}" style="text-decoration:none; color:inherit; display:flex; align-items:center; gap:10px;"><i class="bi bi-file-earmark-arrow-down-fill fs-3 text-primary"></i><div><div class="fw-bold small">${msg.fileName}</div><span class="badge bg-secondary" style="font-size:9px;">FILE</span></div></a></div>`
                : `<div class="message-bubble shadow-sm">${msg.text}</div>`;
            div.innerHTML = `${content}<span class="meta ${type === 'me' ? 'text-end' : ''}">${msg.time}</span>`;
            messageList.appendChild(div);
        }

        // --- SEND & UPLOAD ---
        window.sendMessage = async () => {
            if (isBlocked) return alert("You cannot message a blocked user."); // Guard Clause

            const input = document.getElementById("messageInput");
            const text = input.value.trim();
            if (!text) return;
            input.value = "";
            await saveToDB(text, "text");
        }

        window.sendStarter = async (text) => { await saveToDB(text, "text"); }
        window.handleEnter = (e) => { if(e.key === "Enter") sendMessage(); }

        window.handleFileUpload = () => {
            if (isBlocked) return alert("You cannot message a blocked user."); // Guard Clause

            const fileInput = document.getElementById('fileInput');
            const subjectSelect = document.getElementById('subjectSelect');
            if (fileInput.files.length === 0) return alert("Select file!");
            const file = fileInput.files[0];
            const subject = subjectSelect.value;
            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64 = e.target.result;
                const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
                modal.hide();
                await saveToDB("📎 Shared " + subject + " file", "file", { fileName: file.name, fileData: base64, fileTag: subject });
                fileInput.value = "";
            };
            reader.readAsDataURL(file);
        }

        async function saveToDB(text, type, extraData = {}) {
            const timeString = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            await addDoc(messagesRef, { text, senderId: myUid, createdAt: new Date().toISOString(), time: timeString, type, ...extraData });
            await updateDoc(doc(db, "chats", chatId), { lastMessage: text, lastMessageTime: new Date().toISOString() });
        }

        window.filterChats = () => {
            const input = document.getElementById("searchInput");
            const filter = input.value.toLowerCase();
            const list = document.getElementById("sidebar-list");
            if(!list) return;
            const items = list.getElementsByClassName("chat-item");
            for (let i = 0; i < items.length; i++) {
                const nameEl = items[i].querySelector(".fw-bold");
                const textValue = nameEl.innerText.toLowerCase();
                items[i].style.display = textValue.indexOf(filter) > -1 ? "flex" : "none";
            }
        }

        window.openReportModal = () => new bootstrap.Modal(document.getElementById('reportModal')).show();
    </script>
</body>
</html>